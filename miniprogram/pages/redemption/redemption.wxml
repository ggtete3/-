<!--pages/redemption/redemption.wxml-->
<view class="container">
  <!-- é¡µé¢å¤´éƒ¨ -->
  <view class="header">
    <view class="header-content">
      <text class="page-title">å…‘æ¢è®°å½•</text>
      <text class="page-subtitle">æŸ¥çœ‹æ‚¨çš„ç§¯åˆ†å…‘æ¢è®°å½•</text>
    </view>
  </view>

  <!-- ç­›é€‰æ ‡ç­¾ -->
  <view class="filter-section">
    <scroll-view class="filter-scroll" scroll-x>
      <view class="filter-list">
        <view 
          wx:for="{{statusFilters}}" 
          wx:key="value"
          class="filter-item {{selectedStatus === item.value ? 'active' : ''}}"
          bindtap="changeStatusFilter"
          data-status="{{item.value}}"
        >
          <text class="filter-icon">{{item.icon}}</text>
          <text class="filter-name">{{item.name}}</text>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading && records.length === 0}}" class="loading-state">
    <view class="loading-animation">
      <view class="loading-dot"></view>
      <view class="loading-dot"></view>
      <view class="loading-dot"></view>
    </view>
    <text>åŠ è½½ä¸­...</text>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view wx:elif="{{records.length === 0 && !loading}}" class="empty-state">
    <text class="empty-icon">ğŸ“¦</text>
    <text class="empty-text">æš‚æ— å…‘æ¢è®°å½•</text>
    <text class="empty-subtitle">å¿«å»ç§¯åˆ†å•†åŸå…‘æ¢å¿ƒä»ªå•†å“å§</text>
    <button class="shop-btn" bindtap="goToMall">å»é€›å•†åŸ</button>
  </view>

  <!-- å…‘æ¢è®°å½•åˆ—è¡¨ -->
  <view wx:else class="records-section">
    <view 
      wx:for="{{records}}" 
      wx:key="id"
      class="record-card"
      bindtap="showRecordDetail"
      data-record="{{item}}"
    >
      <view class="record-header">
        <view class="record-info">
          <text class="record-id">å…‘æ¢å•å·ï¼š{{item.id}}</text>
          <text class="record-time">{{item.created_at_formatted}}</text>
        </view>
        <view class="record-status {{item.status}}">
          <text class="status-text">{{item.status_text}}</text>
        </view>
      </view>

      <view class="record-content">
        <image src="{{item.product_image || '/miniprogram/static/images/placeholder/product-placeholder.svg'}}" class="product-image" mode="aspectFill" />
        
        <view class="product-info">
          <text class="product-name">{{item.product_name}}</text>
          <text class="points-cost">æ¶ˆè€—ç§¯åˆ†ï¼š{{item.points_cost}}</text>
          
          <view class="verification-section">
            <view class="verification-code-mini">
              <text class="code-label">æ ¸é”€ç </text>
              <text class="code-value">{{item.verification_code}}</text>
              <button class="copy-mini-btn" bindtap="copyCode" data-code="{{item.verification_code}}" catchtap>
                <text class="copy-icon">ğŸ“‹</text>
              </button>
            </view>
            
            <view wx:if="{{item.status === 'pending'}}" class="expire-info">
              <text class="expire-text">{{item.expire_status}}</text>
            </view>
          </view>
        </view>
      </view>

      <view wx:if="{{item.status === 'pending'}}" class="record-actions">
        <button class="action-btn secondary" bindtap="viewStores" catchtap>æŸ¥çœ‹é—¨åº—</button>
        <button class="action-btn primary" bindtap="showVerificationCode" data-record="{{item}}" catchtap>æŸ¥çœ‹è¯¦æƒ…</button>
      </view>
    </view>

    <!-- åŠ è½½æ›´å¤š -->
    <view class="load-more" wx:if="{{hasMore && records.length > 0}}">
      <button class="load-more-btn" bindtap="loadMoreRecords" loading="{{loading}}">
        {{loading ? 'åŠ è½½ä¸­...' : 'åŠ è½½æ›´å¤š'}}
      </button>
    </view>

    <!-- æ²¡æœ‰æ›´å¤š -->
    <view class="no-more" wx:if="{{!hasMore && records.length > 0}}">
      <text>â€” æ²¡æœ‰æ›´å¤šè®°å½•äº† â€”</text>
    </view>
  </view>

  <!-- åº•éƒ¨å®‰å…¨åŒºåŸŸ -->
  <view class="safe-area-bottom"></view>
</view>

<!-- æ ¸é”€ç è¯¦æƒ…å¼¹çª— -->
<view class="modal-overlay {{showDetailModal ? 'show' : ''}}" bindtap="closeDetailModal">
  <view class="detail-modal" catchtap>
    <view class="modal-header">
      <text class="modal-title">æ ¸é”€è¯¦æƒ…</text>
      <button class="close-btn" bindtap="closeDetailModal">âœ•</button>
    </view>
    
    <view class="modal-content">
      <image src="{{selectedRecord.product_image}}" class="detail-product-image" mode="aspectFill" />
      <text class="detail-product-name">{{selectedRecord.product_name}}</text>
      
      <view class="verification-code-large">
        <text class="code-label">æ ¸é”€ç </text>
        <text class="code-value">{{selectedRecord.verification_code}}</text>
        <button class="copy-btn" bindtap="copyVerificationCode">å¤åˆ¶æ ¸é”€ç </button>
      </view>
      
      <view class="qr-code-section">
        <text class="qr-label">æ ¸é”€äºŒç»´ç </text>
        <view class="qr-code-placeholder">
          <text class="qr-icon">ğŸ“±</text>
          <text class="qr-text">è¯·æˆªå›¾ä¿å­˜åˆ°ç›¸å†Œ</text>
        </view>
      </view>
      
      <view class="detail-info">
        <view class="info-row">
          <text class="info-label">å…‘æ¢æ—¶é—´</text>
          <text class="info-value">{{selectedRecord.created_at_formatted}}</text>
        </view>
        <view class="info-row">
          <text class="info-label">æ¶ˆè€—ç§¯åˆ†</text>
          <text class="info-value">{{selectedRecord.points_cost}}</text>
        </view>
        <view class="info-row">
          <text class="info-label">æœ‰æ•ˆæœŸè‡³</text>
          <text class="info-value">{{selectedRecord.expire_at_formatted}}</text>
        </view>
        <view class="info-row">
          <text class="info-label">çŠ¶æ€</text>
          <text class="info-value {{selectedRecord.status}}">{{selectedRecord.status_text}}</text>
        </view>
      </view>
      
      <view class="usage-tips">
        <text class="tips-title">ğŸ’¡ ä½¿ç”¨è¯´æ˜</text>
        <text class="tips-item">1. åˆ°ä»»æ„åˆä½œé—¨åº—å‡ºç¤ºæ ¸é”€ç </text>
        <text class="tips-item">2. å·¥ä½œäººå‘˜æ‰«ç åå³å¯é¢†å–å•†å“</text>
        <text class="tips-item">3. æ ¸é”€ç ä»…é™ä½¿ç”¨ä¸€æ¬¡</text>
        <text class="tips-item">4. è¶…è¿‡æœ‰æ•ˆæœŸè‡ªåŠ¨å¤±æ•ˆ</text>
      </view>
    </view>
    
    <view class="modal-actions">
      <button class="modal-btn secondary" bindtap="viewStores">æŸ¥çœ‹é—¨åº—</button>
      <button class="modal-btn primary" bindtap="closeDetailModal">æˆ‘çŸ¥é“äº†</button>
    </view>
  </view>
</view>